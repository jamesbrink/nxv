name: Publish Index

# This workflow updates the nxv package index from nixpkgs
# It can be run on a schedule or triggered manually

on:
  # Run weekly on Sunday at 00:00 UTC
  schedule:
    - cron: '0 0 * * 0'

  # Allow manual triggering
  workflow_dispatch:
    inputs:
      full_rebuild:
        description: 'Force full index rebuild'
        required: false
        default: 'false'
        type: boolean

env:
  CARGO_TERM_COLOR: always
  # Index is stored in a GitHub release with this tag
  # Forks can override INDEX_URL_PREFIX via repository variable (Settings > Secrets and variables > Actions > Variables)
  INDEX_RELEASE_TAG: index-latest
  INDEX_URL_PREFIX: ${{ vars.INDEX_URL_PREFIX || format('https://github.com/{0}/releases/download/index-latest', github.repository) }}

jobs:
  update-index:
    name: Update Package Index
    runs-on: ubuntu-latest

    steps:
      - name: Checkout nxv
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v30
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: nxv
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-indexer-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-indexer-

      - name: Build nxv with indexer
        run: cargo build --release --features indexer

      - name: Clone nixpkgs (shallow)
        run: |
          git clone --depth 1000 --single-branch --branch nixos-unstable \
            https://github.com/NixOS/nixpkgs.git nixpkgs

      - name: Download existing index (for incremental update)
        if: ${{ github.event.inputs.full_rebuild != 'true' }}
        continue-on-error: true
        run: |
          set -euo pipefail
          mkdir -p ~/.local/share/nxv
          # Download existing index from GitHub release
          curl -sSfL "${INDEX_URL_PREFIX}/index.db.zst" -o ~/.local/share/nxv/index.db.zst || true
          if [ -f ~/.local/share/nxv/index.db.zst ]; then
            if zstd -d ~/.local/share/nxv/index.db.zst -o ~/.local/share/nxv/index.db; then
              rm ~/.local/share/nxv/index.db.zst
            else
              rm -f ~/.local/share/nxv/index.db.zst ~/.local/share/nxv/index.db
            fi
          fi
          # Also download bloom filter if available
          curl -sSfL "${INDEX_URL_PREFIX}/bloom.bin" -o ~/.local/share/nxv/bloom.bin || true
          if [ -f ~/.local/share/nxv/bloom.bin ] && [ ! -s ~/.local/share/nxv/bloom.bin ]; then
            rm -f ~/.local/share/nxv/bloom.bin
          fi

      - name: Run indexer
        run: |
          if [ "${{ github.event.inputs.full_rebuild }}" = "true" ]; then
            ./target/release/nxv index --nixpkgs-path ./nixpkgs --full
          else
            ./target/release/nxv index --nixpkgs-path ./nixpkgs
          fi

      - name: Generate publishable artifacts
        run: |
          ./target/release/nxv publish \
            --output ./publish \
            --url-prefix "${INDEX_URL_PREFIX}"

      - name: Upload workflow artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nxv-index
          path: publish/
          retention-days: 7

      - name: Upload to GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          # Check if release exists, create if not
          if ! gh release view "$INDEX_RELEASE_TAG" > /dev/null 2>&1; then
            echo "Creating release $INDEX_RELEASE_TAG..."
            gh release create "$INDEX_RELEASE_TAG" \
              --title "Package Index" \
              --notes "nxv package index files. Updated automatically." \
              --latest=false
          fi
          gh release view "$INDEX_RELEASE_TAG" > /dev/null 2>&1

          # Upload files (--clobber overwrites existing assets)
          echo "Uploading index files to release..."
          gh release upload "$INDEX_RELEASE_TAG" \
            publish/index.db.zst \
            publish/bloom.bin \
            publish/manifest.json \
            --clobber

      - name: Summary
        run: |
          echo "## Index Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Index size:** $(du -h publish/index.db.zst | cut -f1)" >> $GITHUB_STEP_SUMMARY
          echo "- **Bloom filter size:** $(du -h publish/bloom.bin 2>/dev/null | cut -f1 || echo 'N/A')" >> $GITHUB_STEP_SUMMARY
          echo "- **Release:** [$INDEX_RELEASE_TAG](https://github.com/${{ github.repository }}/releases/tag/$INDEX_RELEASE_TAG)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          cat publish/manifest.json >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
